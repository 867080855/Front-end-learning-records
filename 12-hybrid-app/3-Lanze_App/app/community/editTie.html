<!doctype html>  
<html class="feedback">  
    <head>  
        <meta charset="utf-8" />  
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />  
        <meta name="misapplication-tap-highlight" content="no" />  
        <meta name="HandheldFriendly" content="true" />  
        <meta name="MobileOptimized" content="320" />  
        <link rel="stylesheet" href="css/mui.min.css">  
        <link rel="stylesheet" type="text/css" href="css/app.css" />
        <link rel="stylesheet" type="text/css" href="css/iconfont.css" />
        <link rel="stylesheet" type="text/css" href="css/feedback-page.css" />
        <link rel="stylesheet" href="css/font-awesome.min.css">


    <style type="text/css">  
            .del {  
                position: absolute;  
                top:1px;  
                right: 1px;    
                display: block;        
                line-height: 1;  
                cursor: pointer;  
                color:#fff;  
            }  
  
            .del:hover {  
                color:#ff3333;  
            }  
        </style>
	<style>  
            .table-view {  
                position: relative;  
                margin-top: 0;  
                margin-bottom: 0;  
                padding-left: 0;  
                list-style: none;  
                background-color: #f5f5f5;  
            }  
              
            .table-view-cell {  
                position: relative;  
                overflow: hidden;  
                padding: 0px 15px;   
                -webkit-touch-callout: none;  
                margin-bottom: 1px;  
            }  
              
            .table-view-cell:after {  
                position: absolute;  
                right: 0;  
                bottom: 0;  
                left: 0px;  
                height: 1px;  
                content: '';  
                -webkit-transform: scaleY(.5);  
                transform: scaleY(.5);  
                background-color: #c8c7cc;  
            }  
              
            .table-view-cell>a:not(.btn) {  
                position: relative;  
                display: block;  
                overflow: hidden;  
                margin: -0px -15px;  
                padding: inherit;  
                white-space: nowrap;  
                text-overflow: ellipsis;  
                color: inherit;  
                background-color: #75b9f4;  
                height: 40px;  
                line-height: 40px;  
            }  
              
            .navigate-right:after  
            {  
                font-family: Muiicons;  
                font-size: inherit;  
                line-height: 1;  
                position: absolute;  
                top: 50%;  
                display: inline-block;  
                -webkit-transform: translateY(-50%);  
                transform: translateY(-50%);  
                text-decoration: none;  
                color: #666;  
                -webkit-font-smoothing: antialiased;  
            }  
              
            .table-view-cell.collapse .collapse-content {  
                position: relative;  
                display: none;  
                overflow: hidden;  
                margin: 0px -15px 0px;  
                padding: 0px 0px !important;  
                -webkit-transition: height .35s ease;  
                -o-transition: height .35s ease;  
                transition: height .35s ease;  
                background-color: transparent;  
            }  
            .image-item{  
                position: relative;  
            }  
            .image-item .info{  
                position: absolute;  
                top:0px;  
                left:4px;  
                color: #ff9900;  
                font-size: 12px;                          
                  
            }  
        </style> 
		<script src="js/jquery.js"></script>
        <script type="text/javascript" src="js/common.js"></script>
        <script type="text/javascript" src="js/utitls.js"></script>
	</head>

	<body>
		<!--头部-->
		<header class="bar bar-nav" style="background-color: #fff;color:#000;box-shadow: 0 1px #ccc;">  
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
            <h1 class="title" style="color:#000;">写帖子</h1>  
            <a id="fabu_btn" href="pullrefresh_main.html" class="pull-right" style="line-height: 44px;">发布</a>
        </header>  
        

		<!--文本内容-->
		<div class="content" style="background-color: #fff;">
			<textarea name="" id="txtcontent" placeholder="我想说..." style="color: #7b7b7b;height: 166px;" class="contenetvalue"></textarea>
		</div>
		
		
		<div class="mui-content" style="background-color:#fff;height:44px;">		
			<div class="mui-table-view-cell mui-clearfix" style="background-color:#fff;height:44px;position: relative;">
				<span style="padding-left:13px;line-height: 44px;"></span>
				<div class="mui-switch mui-active myswitch" style="" >
					<div class="mui-switch-handle"></div>
				</div>
			</div>		
		</div>



<!-- 上传图片的部分 -->
<div class="content" style="padding:0;">   
    <input type="hidden" id="ckjl.id" name="ckjl.id" value="429">  
    <div class="collapse-content" >  
        <form>  
            <!--<label class="row-label"></label>-->  
            <div id='F_CKJLBS' class="row image-list">  

               
                
                <!-- 打开本地图片 -->
                <!--<div class="image-item"id="F_CKJLB" style="width:100%;" >
                      
					  
                </div>-->
                <input id="image" type="file" name="attach_file " class="sahgnhcuan" />
				 <!--<input type="button" name="selbutton" class="selbutton " value="选择文件" />-->
                 <!--<input type="button" name="upbutton" class="upbutton" onclick="UpladFile()" value="上传" />-->
                
        	</div> 
        	 <!-- 图片上传 -->
                <div class="image-item upload" onclick="UpladFile()"  style="width: 100%;height: 40px;background-color: #5CA8FC;color: white;text-align: center;line-height: 40px;">
                    <!--<img src="images/tianjiazhaopian.png" alt="" />-->
                    	上传图片
                </div>
        </form>  
    </div>  
</div>


<script src="../../js/mui.min.js"></script>

<!--发布帖子-->
<script>
	var fabu_btn = document.querySelector('#fabu_btn');
	var multiInput = document.querySelector('textarea');
	
	var imgarr = '';
	var imgarrChild = '';
	
	var posiFlag = false;
	var islocalseqwe=1;	
	// 获取地理位置信息
	// 扩展API加载完毕，现在可以正常调用扩展API
	document.addEventListener( "plusready", onPlusReady, false );
	function onPlusReady() {
				plus.webview.close('pullrefresh_sub.html');
		
		
				wid = plus.geolocation.getCurrentPosition( function ( p ) {
				
				
				
			
				var address = p.address.city;
				var cityName = document.querySelector('#cityName');
//				alert(JSON.stringify(p));
				localStorage.setItem('address',JSON.stringify(p));
				
				
//				alert(address);
//				var posi = document.querySelector('#posi');
//				posi.innerHTML = p.address.district + '/' + p.address.poiName;
							
					value = p.address.district + '/' + p.address.poiName;
					sessionStorage.setItem('posiAddress',value);
					res.innerText = value;
			}, function ( e ) {
//				alert( "Geolocation error: " + e.message );
		} );
		
		
		
		mui('.mui-content .mui-switch').each(function() { //循环所有toggle
				//toggle.classList.contains('mui-active') 可识别该toggle的开关状态
				res = this.parentNode.querySelector('span');
				value = '';
				if(this.classList.contains('mui-active')){
					value = '正在获取地理位置...';
				}else{
					value = '正在获取地理位置...';
				}
				
				
				
//				if(posiFlag) {
//					var address = localStorage.getItem('address');
//					address = JSON.parse(address);
//					
//					value = address.poiName;
//				}
				
				res.innerText = value;
//				 
				/**
				 * toggle 事件监听
				 */
				this.addEventListener('toggle', function(event) {
//					//event.detail.isActive 可直接获取当前状态
//					
				if(event.detail.isActive){
					islocalseqwe=1;
					if(sessionStorage.getItem('posiAddress')){
						value = sessionStorage.getItem('posiAddress');
					}else {
						value = '正在获取地理信息'
					}
				}else{
					islocalseqwe=2;
					value = '位置已关闭';
				}
				res.innerText = value;
				});
			});
	}
	
	fabu_btn.addEventListener('click',function(){
//		alert('done');
		fabu();
		//上传完成后，文本框内晴空内容
		var txtcontent = document.querySelector('#txtcontent');
		txtcontent.value='';
//		delImgFromLocal();
//		alert(txtcontent.value);
	})
	
	function fabu(){
		
		if(imgarrChild != null){
			imgarr += imgarrChild;	// 需要上传的图片地址字符串
		}
		


		var address = localStorage.getItem('address');
		address = JSON.parse(address);
		var province = address.address.province;
		var city = address.address.city;
		var district = address.address.district;
		var street = address.address.street;
		var poiName = address.address.poiName;
//		alert(province + city + district + street + poiName);
		
		var latitude = address.coords.latitude;
		var longitude = address.coords.longitude;
//		alert(latitude + ' '+ longitude);
		
		
		// 向后台提交帖子的数据
		mui.ajax($$$.siturl + 'm=App&c=InfoMeber&a=releaseDis',{
			type:'post',
			data:{
				img:imgarr,
				title:'title',
				content:multiInput.value,
				province:province,
				city:city,
				district:district,
				street:street,
				poiName:poiName,
				latitude:latitude,
				longitude:longitude,
				islocalse:islocalseqwe
			},
			dataType:'json',
			success:function(data){
				mui.toast(data.msg);

				/*mui.openWindow({
				    url:'pullrefresh_sub.html',
				    id:'pullrefresh_sub.html',
				    createNew:false,//是否重复创建同样id的webview，默认为false:不重复创建，直接显示
				})*/
				
			},
			error:function(xhr,err){
//				alert(xhr);
//				alert(err);
				alert('发布成功');
			}
		});
		
	}
</script>

<script>
	
	var imgarrChild = '';
	function UpladFile() {

            var fileObj = document.querySelector(".sahgnhcuan").files[0]; // js 获取文件对象

            var FileController = $$$.siturl+"m=App&c=index&a=addImg";                    // 接收上传文件的后台地址 

            // FormData 对象

            var form = new FormData();
//          console.log(JSON.stringify(form));
//          alert('donw');
            
            // 可以增加表单数据 

            form.append("attach_file", fileObj);                           // 文件对象

            // XMLHttpRequest 对象

            var xhr = new XMLHttpRequest();

            xhr.open("post", FileController, true);

			xhr.onload = function () {

			};
			
			
//			alert('donw');
        	xhr.onreadystatechange=function() // 状态改变回调函数
			{
				// 判断 request.readyState==4 的效果等同于 onload 
				if(xhr.readyState==4 && xhr.status==200)
				{
                    var d = 'json' == 'xml'? xhr.responseXML: xhr.responseText;

                    d = JSON.parse(d);
//                  alert(1);
                    imgarrChild = d.content;
                    alert('上传成功！');
//					alert(d.content);
				}
			};


//
//      	function progressFunction(evt) {
//
//          var progressBar = document.getElementByIdx_x_x("progressBar");
//
//          var percentageDiv = document.getElementByIdx_x_x("percentage");
//
//          if (evt.lengthComputable) {
//
//              progressBar.max = evt.total;
//
//              progressBar.value = evt.loaded;
//
//              percentageDiv.innerHTML = Math.round(evt.loaded / evt.total * 100) + "%";
//
//          }
//
//      }  
           // xhr.upload.addEventListener("progress", progressFunction, false);
		   xhr.send(form);

    }
</script>

	
	
</body>
	
	
	
	<script>
			mui.init({
//				swipeBack:true //启用右滑关闭功能
			});
			

		</script>
</html>